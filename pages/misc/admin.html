<template>
  <div id="admin" style="padding: 0px; display: flex;">
    <div id="admin-side-bar">
      <div class="sidebar-section">Tables<hr /></div>
    </div>
    <div id="admin-content">
      <h2>Admin page</h2>
      <h3 id="table-name"></h3>
      <br/>
      <table id="db-table">
      </table>
    </div>
  </div>
</template>

<style>
  table {
    border-collapse: collapse;
  }
  th, td {
    border: solid 1px black;
    padding: 5px 10px;
    font-family: sans-serif;
    font-size: 12px;
    max-width: 100px;
    overflow-x: scroll;
  }
  thead th {
    font-weight: bold;
  }
  #admin-content {
    padding: 15px;
  }
  #admin-side-bar {
    z-index: 1;
    width: 300px;
    height: 100vh;
    background: #eeeeee;
    color: black;
    box-shadow: 0px 0px 10px rgba(0,0,0,.5);
  }
</style>

<script>
  function get_admin_tables() {
    if (!document.getElementById('admin-side-bar')) {
      return;
    }
    const http = new XMLHttpRequest();
    http.open("get", "/api/get-tables");
    http.send();
    http.onreadystatechange = (e) => {
      
      if (http.readyState == 4 && http.status == 200) {
        let tables = JSON.parse(http.responseText);
        document.getElementById('admin-side-bar').innerHTML = `<div class="sidebar-section">Tables<hr /></div>`;
        for (let i = 0; i < tables.length; i++) {
          let link_html = `<div class="sidebar-link" id="${tables[i].snakecase}" onclick="select_table('${tables[i].snakecase}')">${tables[i].name}</div>`
          document.getElementById('admin-side-bar').innerHTML += link_html;
          console.log(tables[i].name)
        }
      }
      
    }
  }

  //  Select a table.
  function select_table(table_name) {
    //  Update sidebar link style.
    var selected_elements = document.getElementsByClassName('selected');
    for (var i = 0; i < selected_elements.length; i++) {
      selected_elements[i].classList.remove('selected');
    }
    document.getElementById(table_name).classList.add('selected');

    //  Get & display data.
    const http = new XMLHttpRequest();
    http.open("get", `/api/${table_name}-table`);
    http.send();
    http.onreadystatechange = (e) => {
      
      if (http.readyState == 4 && http.status == 200) {
        let table = JSON.parse(http.responseText);
        document.getElementById('table-name').innerHTML = table.name
        console.log(table)
        let db_table_html = '<thead><tr>';
        console.log(table.columns)
        for (let i = 0; i < table.columns.columns.length; i++) {
          db_table_html += `<td>${table.columns.columns[i].name}</td>`;
        }
        db_table_html += '</tr></thead><tbody>';
        // rows here
        for (let i = 0; i < table.rows.length; i++) {
          db_table_html += `<tr>`;
          for (let j = 0; j < table.columns.columns.length; j++) {
            let key = table.columns.columns[j].snakecase;
            db_table_html += `<td>${table.rows[i][key]}</td>`;
          }
          db_table_html += `</tr>`;
        }
        document.getElementById('db-table').innerHTML = db_table_html + '</tbody>';
      }
      
    }
  }

  setTimeout(get_admin_tables, 200)

</script>