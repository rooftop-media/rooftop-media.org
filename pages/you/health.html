<template>
  <div id="health">
    <div class="text-form">
      <h2>Your Health</h2>
      <h3>Insurance</h3>
      <p>Insurance: <input id="insurance" /></p>
      <hr/>
      <h3>Facilities</h3>
      <p>General care: <input id="general" /></p>
      <p>Dentist: <input id="dentist" /></p>
      <p>Optometrist: <input id="optometrist" /></p>
      <p>Mental healthcare: <input id="mental" /></p>
      <p>Allergist: <input id="allergist" /></p>
      <hr />
      <h3>Health info</h3>
      <p>Blood type: <input id="blood_type" /></p>
      <p>Conditions: <input id="conditions" /></p>
      <h3>Last checkup</h3>
      <p>Date: <input id="last_checkup_date" /></p>
      <p>Blood pressure: <input id="blood_pressure" /></p>
    </div>
    <button onclick="update_health()">
      Update health info
    </button>
  </div>
</template>

<script>
  function load_health() {
    const http = new XMLHttpRequest();
    http.open("POST", "/api/user-health-by-user");
    http.send(_current_user.id.toString());
    http.onreadystatechange = (e) => {
      if (http.readyState == 4 && http.status == 200) {
        let response = JSON.parse(http.responseText);
        document.getElementById('insurance').value = response.insurance;
        document.getElementById('general').value = response.general;
        document.getElementById('dentist').value = response.dentist;
        document.getElementById('optometrist').value = response.optometrist;
        document.getElementById('mental').value = response.mental;
        document.getElementById('allergist').value = response.allergist;
        document.getElementById('blood_type').value = response.blood_type;
        document.getElementById('conditions').value = response.conditions;
        document.getElementById('last_checkup_date').value = response.last_checkup_date;
        document.getElementById('blood_pressure').value = response.blood_pressure;
      }
    }
  }
  load_health();

  function update_health() {
    let insurance = document.getElementById('insurance').value;
    let general = document.getElementById('general').value;
    let dentist = document.getElementById('dentist').value;
    let optometrist = document.getElementById('optometrist').value;
    let mental = document.getElementById('mental').value;
    let allergist = document.getElementById('allergist').value;
    let blood_type = document.getElementById('blood_type').value;
    let conditions = document.getElementById('conditions').value;
    let last_checkup_date = document.getElementById('last_checkup_date').value;
    let blood_pressure = document.getElementById('blood_pressure').value;
    
    if (!_current_user || !_current_user.id) {
      document.getElementById('error').innerHTML = 'Must be logged in..';
      return;
    }

    const http = new XMLHttpRequest();
    http.open("POST", "/api/update-user-health");
    http.send(JSON.stringify({
      user_id: _current_user.id,
      insurance,
      general,
      dentist,
      optometrist,
      mental,
      allergist,
      blood_type,
      conditions,
      last_checkup_date,
      blood_pressure
    }));
    http.onreadystatechange = (e) => {
      console.log(http.responseText)
      let response;      
      if (http.readyState == 4 && http.status == 200) {
        console.log("Response recieved! Updated your user-health.")
      } else {
        document.getElementById('error').innerHTML = "Error updating health info.";
      }
    }
  }
</script>